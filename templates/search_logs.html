{% extends "base.html" %}

{% block title %}Search Logs - MongoDB Log Analyzer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Search MongoDB Logs</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            {% if search_performed and results %}
            <button type="button" class="btn btn-sm btn-success" id="exportBtn">
                <i class="fas fa-download me-2"></i>Export Results
            </button>
            {% endif %}
            <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Search Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-search me-2"></i>Search Criteria</h5>
                {% if min_date and max_date %}
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>Log data available from {{ min_date }} to {{ max_date }}
                </small>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('search_logs') }}" class="row g-3">
                    
                    
                    <!-- Date Range -->
                    <div class="col-md-4">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="datetime-local" class="form-control" id="start_date" name="start_date" 
                               value="{{ start_date or '' }}"
                               {% if min_date %}min="{{ min_date }}"{% endif %}
                               {% if max_date %}max="{{ max_date }}"{% endif %}>
                        {% if min_date %}
                        <small class="form-text text-muted">Available: {{ min_date }} to {{ max_date }}</small>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="datetime-local" class="form-control" id="end_date" name="end_date" 
                               value="{{ end_date or '' }}"
                               {% if min_date %}min="{{ min_date }}"{% endif %}
                               {% if max_date %}max="{{ max_date }}"{% endif %}>
                        {% if max_date %}
                        <small class="form-text text-muted">Available: {{ min_date }} to {{ max_date }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- Options & Chained Conditions -->
                    <div class="col-md-2">
                        <label for="limit" class="form-label">Max Results</label>
                        <select class="form-select" id="limit" name="limit">
                            <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                            <option value="250" {% if limit == 250 %}selected{% endif %}>250</option>
                            <option value="500" {% if limit == 500 %}selected{% endif %}>500</option>
                            <option value="1000" {% if limit == 1000 %}selected{% endif %}>1000</option>
                        </select>
                    </div>

                    <div class="col-12 mt-3">
                        <h6 class="mb-2">Additional Conditions (AND)</h6>
                        <div id="conditionsContainer"></div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addConditionBtn">
                            <i class="fas fa-plus me-1"></i>Add Condition
                        </button>
                        <div class="form-text">Date range is applied first, then each condition in order (like grep | grep).</div>
                    </div>
                    
                    <div class="col-12">
                        {% if min_date and max_date %}
                        <div class="mb-3">
                            <small class="text-muted me-2">Quick Date Select:</small>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('all')">
                                <i class="fas fa-calendar-alt me-1"></i>All Data
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('today')">
                                <i class="fas fa-calendar-day me-1"></i>Today
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('last24h')">
                                <i class="fas fa-clock me-1"></i>Last 24h
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('last7d')">
                                <i class="fas fa-calendar-week me-1"></i>Last 7 days
                            </button>
                        </div>
                        {% endif %}
                        <button type="submit" class="btn btn-primary me-2" id="searchBtn">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                        <a href="{{ url_for('search_logs') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-undo me-2"></i>Clear
                        </a>
                    </div>
                </form>
                <script>
                (function(){
                  const container = document.getElementById('conditionsContainer');
                  const addBtn = document.getElementById('addConditionBtn');
                  let nextIndex = 0;

                  function row(idx, preset){
                    const d = document.createElement('div');
                    d.className = 'row g-2 align-items-end mb-2';
                    d.dataset.idx = idx;
                    d.innerHTML = `
                      <div class=\"col-md-2\">\n        <label class=\"form-label\">Type<\/label>\n        <select class=\"form-select\" name=\"filters[${idx}][type]\">\n          <option value=\"keyword\" ${preset&&preset.type==='keyword'?'selected':''}>Keyword<\/option>\n          <option value=\"field\" ${preset&&preset.type==='field'?'selected':''}>Field<\/option>\n        <\/select>\n      <\/div>\n      <div class=\"col-md-3\">\n        <label class=\"form-label\">Field (for Field type)<\/label>\n        <input class=\"form-control\" name=\"filters[${idx}][name]\" value=\"${preset&&preset.name?preset.name:''}\" placeholder=\"e.g., attr.ns\">\n      <\/div>\n      <div class=\"col-md-3\">\n        <label class=\"form-label\">Value<\/label>\n        <input class=\"form-control\" name=\"filters[${idx}][value]\" value=\"${preset&&preset.value?preset.value:''}\" placeholder=\"Search text or regex\">\n      <\/div>\n      <div class=\"col-md-3\">\n        <div class=\"form-check\"><input class=\"form-check-input\" type=\"checkbox\" id=\"f${idx}_regex\" name=\"filters[${idx}][regex]\" ${preset&&preset.regex?'checked':''}><label class=\"form-check-label\" for=\"f${idx}_regex\">Regex<\/label><\/div>\n        <div class=\"form-check\"><input class=\"form-check-input\" type=\"checkbox\" id=\"f${idx}_case\"  name=\"filters[${idx}][case]\"  ${preset&&preset.case_sensitive?'checked':''}><label class=\"form-check-label\" for=\"f${idx}_case\">Case sensitive<\/label><\/div>\n        <div class=\"form-check\"><input class=\"form-check-input\" type=\"checkbox\" id=\"f${idx}_not\"   name=\"filters[${idx}][not]\"   ${preset&&preset.negate?'checked':''}><label class=\"form-check-label\" for=\"f${idx}_not\">NOT (exclude)<\/label><\/div>\n      <\/div>\n      <div class=\"col-md-1 text-end\"><button type=\"button\" class=\"btn btn-sm btn-outline-danger\" data-remove=\"${idx}\"><i class=\"fas fa-times\"><\/i><\/button><\/div>`;
                    return d;
                  }

                  addBtn?.addEventListener('click', function(){ container.appendChild(row(nextIndex++, null)); });
                  container?.addEventListener('click', function(e){ const btn=e.target.closest('button[data-remove]'); if(!btn) return; const idx=btn.getAttribute('data-remove'); const r=container.querySelector(`div[data-idx=\\"${idx}\\"]`); r&&r.remove(); });

                  // Rehydrate from URL
                  const params = new URLSearchParams(window.location.search);
                  const idxs = [];
                  params.forEach((v,k)=>{ if(k.startsWith('filters[') && k.endsWith('][type]')){ const i=k.split('[')[1].split(']')[0]; if(!idxs.includes(i)) idxs.push(i);} });
                  idxs.sort((a,b)=>parseInt(a)-parseInt(b));
                  idxs.forEach(function(i){
                    const preset={
                      type: params.get(`filters[${i}][type]`)||'keyword',
                      name: params.get(`filters[${i}][name]`)||'',
                      value: params.get(`filters[${i}][value]`)||'',
                      regex: ['on','true','1'].includes(params.get(`filters[${i}][regex]`)),
                      case_sensitive: ['on','true','1'].includes(params.get(`filters[${i}][case]`)),
                      negate: ['on','true','1'].includes(params.get(`filters[${i}][not]`)),
                    };
                    container.appendChild(row(i, preset));
                    nextIndex=Math.max(nextIndex, parseInt(i,10)+1);
                  });
                })();
                </script>
                
                <!-- Search Examples -->
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Examples:</strong><br>
                        • Keyword: <code>Authentication failed</code><br>
                        • Field search: <code>c</code> = <code>COMMAND</code><br>
                        • Regex: <code>ns</code> = <code>dashboard.*</code><br>
                        • Nested field: <code>attr.remote</code> = <code>10.244.*</code>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results -->
{% if error_message %}
<div class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error_message }}
</div>
{% endif %}

{% if search_performed %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Search Results
                    <span class="badge bg-primary">{{ result_count }}</span>
                </h5>
                {% if results %}
                <small class="text-muted">
                    {% if result_count >= limit %}Showing first {{ limit }} results{% else %}{{ result_count }} results found{% endif %}
                </small>
                {% endif %}
            </div>
            <div class="card-body">
                {% if heavy_search_warning %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Showing the first {{ limit }} matches for a very broad search. Add filters or a date range to narrow the results and compute an exact total.
                </div>
                {% elif search_performed and not total_found_exact %}
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    Showing the first {{ limit }} results. Refine the search to calculate the full total.
                </div>
                {% endif %}
                {% if results %}
                    <!-- Pagination controls -->
                    {% if pagination %}
                        {% include 'pagination.html' %}
                    {% endif %}
                    
                    <div class="table-responsive" style="overflow-x: auto;">
                        <table class="table table-bordered table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th style="min-width: 80px; color: #000; font-weight: bold;">#</th>
                                    <th style="min-width: 140px; color: #000; font-weight: bold;">Timestamp</th>
                                    <th style="min-width: 600px; color: #000; font-weight: bold;">Log Entry</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr>
                                    <td class="text-center">{{ loop.index }}</td>
                                    <td>
                                        {% set timestamp = result.timestamp if result is mapping else (result.timestamp if result.timestamp is defined else None) %}
                                        {% if timestamp %}
                                            <small>{{ timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                        {% else %}
                                            <small class="text-muted">N/A</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="log-entry" style="font-family: monospace; font-size: 0.85em; 
                                             max-height: 200px; overflow-y: auto; white-space: pre-wrap; 
                                             word-break: break-all; background-color: #f8f9fa; padding: 8px; 
                                             border-radius: 4px; border: 1px solid #dee2e6;">{{ result.raw_line }}</div>
                                        <button class="btn btn-sm btn-outline-primary mt-2" 
                                                data-bs-toggle="modal"
                                                data-bs-target="#logModal"
                                                data-log-number="{{ loop.index }}"
                                                data-timestamp="{{ timestamp.strftime('%Y-%m-%d %H:%M:%S') if timestamp else 'N/A' }}"
                                                data-log-entry="{{ (result.raw_line if result is mapping else (result.raw_line if result.raw_line is defined else ''))|e }}">
                                            <i class="fas fa-expand-alt me-1"></i>View Full
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div class="mb-3">
                            <i class="fas fa-search fa-3x text-muted"></i>
                        </div>
                        <h4 class="text-muted">No Results Found</h4>
                        <p class="text-muted">
                            No log entries matched your search criteria. Try adjusting your search terms or filters.
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% elif not search_performed %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info" role="alert">
            <h4 class="alert-heading">Search MongoDB Logs</h4>
            <p>Use the search form above to find specific log entries. You can search by:</p>
            <ul>
                <li><strong>Keywords:</strong> Search for text anywhere in log entries</li>
                <li><strong>Field-specific:</strong> Search within specific JSON fields</li>
                <li><strong>Regex patterns:</strong> Use regular expressions for complex matching</li>
                <li><strong>Date ranges:</strong> Filter results by timestamp</li>
            </ul>
        </div>
    </div>
</div>
{% endif %}

<!-- Full Log Entry Modal -->
<div class="modal fade" id="logModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Entry #</label>
                        <p id="modalLogNumber" class="mb-0"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Timestamp</label>
                        <p id="modalTimestamp" class="mb-0"></p>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Full Log Entry</label>
                    <pre id="fullLogEntry" class="bg-light p-3 rounded" 
                         style="white-space: pre-wrap; word-break: break-all; max-height: 400px; overflow-y: auto; 
                                font-family: monospace; font-size: 0.9em;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyLogEntry()">
                    <i class="fas fa-copy me-2"></i>Copy Entry
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Modal functionality
document.addEventListener('DOMContentLoaded', function() {
    const logModal = document.getElementById('logModal');
    
    if (logModal) {
        logModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;

            const logNumber = button.getAttribute('data-log-number');
            const timestamp = button.getAttribute('data-timestamp');
            const logEntry = button.getAttribute('data-log-entry');

            document.getElementById('modalLogNumber').textContent = logNumber;
            document.getElementById('modalTimestamp').textContent = timestamp;
            document.getElementById('fullLogEntry').textContent = logEntry;
        });
    }
    
    // Export functionality
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const params = new URLSearchParams(window.location.search);
            const exportUrl = '{{ url_for("export_search_results") }}?' + params.toString();
            window.open(exportUrl, '_blank');
        });
    }
});

// Copy function
function copyLogEntry() {
    const logText = document.getElementById('fullLogEntry').textContent;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(logText).then(function() {
            const btn = document.querySelector('.modal-footer .btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        }).catch(function(err) {
            console.error('Copy failed:', err);
            alert('Copy failed. Please select and copy manually.');
        });
    } else {
        // Fallback: select text for manual copy
        const logElement = document.getElementById('fullLogEntry');
        const range = document.createRange();
        range.selectNodeContents(logElement);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        
        alert('Text selected. Please press Ctrl+C (Cmd+C on Mac) to copy.');
    }
}

// (Legacy keyword/field UI removed)

// Date range functionality
function setDateRange(range) {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const now = new Date();
    
    // Get the available date range from the template
    const minDateStr = "{{ min_date if min_date else '' }}";
    const maxDateStr = "{{ max_date if max_date else '' }}";
    
    let startDate, endDate;
    
    switch(range) {
        case 'all':
            startDate = minDateStr ? new Date(minDateStr.replace(' ', 'T')) : null;
            endDate = maxDateStr ? new Date(maxDateStr.replace(' ', 'T')) : null;
            break;
        case 'today':
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            startDate = today;
            endDate = new Date(today.getTime() + 24*60*60*1000 - 1); // End of day
            break;
        case 'last24h':
            endDate = new Date(now);
            startDate = new Date(now.getTime() - 24*60*60*1000);
            break;
        case 'last7d':
            endDate = new Date(now);
            startDate = new Date(now.getTime() - 7*24*60*60*1000);
            break;
    }
    
    // Apply min/max constraints
    if (minDateStr && startDate) {
        const minDate = new Date(minDateStr.replace(' ', 'T'));
        if (startDate < minDate) startDate = minDate;
    }
    if (maxDateStr && endDate) {
        const maxDate = new Date(maxDateStr.replace(' ', 'T'));
        if (endDate > maxDate) endDate = maxDate;
    }
    
    // Set the input values
    if (startDate) {
        startDateInput.value = formatDateTimeLocal(startDate);
    } else {
        startDateInput.value = '';
    }
    
    if (endDate) {
        endDateInput.value = formatDateTimeLocal(endDate);
    } else {
        endDateInput.value = '';
    }
}

function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}
</script>

{% endblock %}
