{% extends "base.html" %}

{% block title %}Dashboard - MongoDB Log Analyzer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">MongoDB Logs Summary</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('slow_queries') }}" class="btn btn-sm btn-warning">
                <i class="fas fa-clock me-2"></i>Slow Query Analysis
            </a>
            <a href="{{ url_for('search_logs') }}" class="btn btn-sm btn-info">
                <i class="fas fa-search me-2"></i>Search Logs
            </a>
            <a href="{{ url_for('current_op_analyzer') }}" class="btn btn-sm btn-primary">
                <i class="fas fa-terminal me-2"></i>CurrentOp Analyzer
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-secondary">Upload New Log</a>
        </div>
    </div>
</div>


{% if stats %}
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats border-left-info">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Slow Queries</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.slow_queries_count }}</div>
                        {% if stats.avg_duration %}
                        <div class="text-xs text-muted">Avg: {{ "%.1f"|format(stats.avg_duration) }}ms</div>
                        {% endif %}
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-info text-white">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats border-left-primary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Top IP Address</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.top_ip.ip }}</div>
                        <div class="text-xs text-muted">{{ stats.top_ip.auth_count }} authentications</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-primary text-white">
                            <i class="fas fa-network-wired"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats border-left-success">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Top Namespace</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.top_namespace.namespace }}</div>
                        <div class="text-xs text-muted">{{ stats.top_namespace.query_count }} queries</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-success text-white">
                            <i class="fas fa-database"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats border-left-warning">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Top App User</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.top_user.user }}</div>
                        <div class="text-xs text-muted">{{ stats.top_user.total_activity }} activities</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-warning text-white">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats border-left-secondary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">Unique Namespaces</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.unique_namespaces }}</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-secondary text-white">
                            <i class="fas fa-layer-group"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats border-left-danger">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Performance Issues</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.performance_issues }}</div>
                        <div class="text-xs text-muted">COLLSCAN queries</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-danger text-white">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats border-left-info">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Unique Databases</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.unique_databases }}</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-info text-white">
                            <i class="fas fa-database"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card card-stats border-left-primary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Query Patterns</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.unique_patterns }}</div>
                        <div class="text-xs text-muted">unique hashes</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-primary text-white">
                            <i class="fas fa-fingerprint"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-network-wired me-1"></i>
                Top IP Addresses
            </div>
            <div class="card-body">
                {% if stats.top_ips %}
                    <div style="max-height: 400px; overflow-y: auto;">
                        {% for ip in stats.top_ips %}
                        <div class="d-flex align-items-center justify-content-between mb-3 p-2 border-bottom">
                            <div class="flex-grow-1">
                                <div class="fw-bold text-primary">{{ ip.ip }}</div>
                                <small class="text-muted">
                                    {{ ip.auth_count }} authentications • {{ ip.unique_users }} users
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">{{ loop.index }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('search_user_access') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-search me-1"></i>View All IP Access
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted">No IP address data found.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-database me-1"></i>
                Top Namespaces Used
            </div>
            <div class="card-body">
                {% if stats.top_namespaces %}
                    <div style="max-height: 400px; overflow-y: auto;">
                        {% for ns in stats.top_namespaces %}
                        <div class="d-flex align-items-center justify-content-between mb-3 p-2 border-bottom">
                            <div class="flex-grow-1">
                                <div class="fw-bold text-success">{{ ns.namespace }}</div>
                                <small class="text-muted">
                                    {{ ns.query_count }} queries • Avg: {{ "%.1f"|format(ns.avg_duration) }}ms
                                    {% if ns.collscan_count > 0 %}
                                    • <span class="text-danger">{{ ns.collscan_count }} COLLSCAN</span>
                                    {% endif %}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success">{{ loop.index }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('slow_queries') }}" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-clock me-1"></i>View Slow Queries
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted">No namespace data found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Top Users Section -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-users me-1"></i>
                Top Application Users
            </div>
            <div class="card-body">
                {% if stats.top_users %}
                    <div class="row">
                        {% for user in stats.top_users %}
                        <div class="col-lg-6 col-xl-4 mb-3">
                            <div class="card border-left-warning h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="fw-bold text-warning">{{ user.user }}</div>
                                            <small class="text-muted">
                                                <span class="text-success">{{ user.success_logins }} success</span> / <span class="text-danger">{{ user.failed_logins }} failed</span> logins<br>
                                                {% if user.last_seen %}
                                                <i class="fas fa-clock me-1"></i>Last: 
                                                {% if user.last_seen.strftime %}
                                                    {% if user.last_seen.tzinfo %}
                                                        {{ user.last_seen.strftime('%Y-%m-%d %H:%M %Z') }}
                                                    {% else %}
                                                        {{ user.last_seen.strftime('%Y-%m-%d %H:%M') }}
                                                    {% endif %}
                                                {% else %}
                                                    {{ user.last_seen }}
                                                {% endif %}
                                                {% if user.last_login_ip %} - {{ user.last_login_ip }}{% endif %}{% if user.last_login_conn_id %} ({{ user.last_login_conn_id }}){% endif %}
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-warning">{{ loop.index }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('search_user_access') }}" class="btn btn-sm btn-outline-warning">
                            <i class="fas fa-user me-1"></i>View All User Access
                        </a>
                    </div>
                {% else %}
                    <p class="text-muted">No user activity data found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>



{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info" role="alert">
            <h4 class="alert-heading">No Data Available</h4>
            <p>No MongoDB log file has been analyzed yet. Please upload a log file to see the connection analysis.</p>
            <hr>
            <a href="{{ url_for('index') }}" class="btn btn-primary">Upload Log File</a>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}