{% extends "base.html" %}

{% block title %}Query Trends - MongoDB Log Analyzer{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-line"></i> Query Trends
    </h1>
    <p class="text-muted mb-0">Analyze query execution patterns and performance trends over time</p>
</div>

<!-- Grouping Options -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex align-items-center">
            <span class="me-2 fw-bold text-info"><i class="fas fa-object-group me-1"></i>Group By:</span>
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="groupingType" id="patternKey" value="pattern_key" 
                       {% if grouping_type == 'pattern_key' %}checked{% endif %}>
                <label class="btn btn-outline-info btn-sm" for="patternKey">
                    <i class="fas fa-fingerprint me-1"></i>Pattern
                </label>
                
                <input type="radio" class="btn-check" name="groupingType" id="namespace" value="namespace" 
                       {% if grouping_type == 'namespace' %}checked{% endif %}>
                <label class="btn btn-outline-info btn-sm" for="namespace">
                    <i class="fas fa-database me-1"></i>Namespace
                </label>
                
                <input type="radio" class="btn-check" name="groupingType" id="queryHash" value="query_hash" 
                       {% if grouping_type == 'query_hash' %}checked{% endif %}>
                <label class="btn btn-outline-info btn-sm" for="queryHash">
                    <i class="fas fa-hashtag me-1"></i>Query Hash
                </label>
            </div>
            <small class="text-muted ms-3">
                {% if grouping_type == 'pattern_key' %}
                    Groups by query structure + namespace + execution plan
                {% elif grouping_type == 'namespace' %}
                    Groups by database.collection only
                {% else %}
                    Groups by query structure only (ignores namespace/plan)
                {% endif %}
            </small>
        </div>
    </div>
</div>

<!-- Filter Options -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="{{ url_for('query_trend') }}" class="row g-3">
                    <!-- Preserve grouping type -->
                    <input type="hidden" name="groupingType" value="{{ grouping_type }}">
                    
                    <div class="col-md-4">
                        <label for="database" class="form-label">Database</label>
                        <select class="form-select" id="database" name="database">
                            <option value="all" {% if selected_db == 'all' %}selected{% endif %}>All Databases</option>
                            {% for db in databases %}
                            <option value="{{ db }}" {% if selected_db == db %}selected{% endif %}>{{ db }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="namespace" class="form-label">Namespace</label>
                        <select class="form-select" id="namespace" name="namespace">
                            <option value="all" {% if selected_namespace == 'all' %}selected{% endif %}>All Namespaces</option>
                            {% for ns in namespaces %}
                            <option value="{{ ns }}" {% if selected_namespace == ns %}selected{% endif %}>{{ ns }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-filter me-1"></i>Apply Filters
                        </button>
                        <a href="{{ url_for('query_trend') }}?groupingType={{ grouping_type }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Statistics -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card card-stats">
            <div class="card-body text-center">
                <div class="stats-icon bg-primary text-white mx-auto mb-3">
                    <i class="fas fa-play"></i>
                </div>
                <h4 class="text-primary">{{ "{:,}".format(stats.total_executions if stats else 0) }}</h4>
                <p class="card-text text-muted">Total Executions</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stats">
            <div class="card-body text-center">
                <div class="stats-icon bg-warning text-white mx-auto mb-3">
                    <i class="fas fa-clock"></i>
                </div>
                <h4 class="text-warning">{{ "{:.0f}".format(stats.avg_duration if stats else 0) }}ms</h4>
                <p class="card-text text-muted">Avg Duration</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stats">
            <div class="card-body text-center">
                <div class="stats-icon bg-danger text-white mx-auto mb-3">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h4 class="text-danger">{{ "{:,}".format(stats.max_duration if stats else 0) }}ms</h4>
                <p class="card-text text-muted">Max Duration</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stats">
            <div class="card-body text-center">
                <div class="stats-icon bg-info text-white mx-auto mb-3">
                    <i class="fas fa-code"></i>
                </div>
                <h4 class="text-info">{{ stats.unique_patterns if stats else 0 }}</h4>
                <p class="card-text text-muted">Unique Patterns</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stats">
            <div class="card-body text-center">
                <div class="stats-icon bg-success text-white mx-auto mb-3">
                    <i class="fas fa-database"></i>
                </div>
                <h4 class="text-success">{{ stats.unique_namespaces if stats else 0 }}</h4>
                <p class="card-text text-muted">Namespaces</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card card-stats">
            <div class="card-body text-center">
                <div class="stats-icon bg-secondary text-white mx-auto mb-3">
                    <i class="fas fa-cogs"></i>
                </div>
                <h4 class="text-secondary">{{ stats.unique_operations if stats else 0 }}</h4>
                <p class="card-text text-muted">Operations</p>
            </div>
        </div>
    </div>
</div>

<!-- Scatter Plot -->
{% if trend_data %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card card-stats">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-chart-scatter"></i> Query Execution Time Trend
                </h5>
                <small class="text-muted">Click on data points to view query details</small>
            </div>
            <div class="card-body p-0">
                <div id="trendChart" style="height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Top Queries Table -->
<div class="row">
    <div class="col-12">
        <div class="card card-stats">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i> Top Queries by Total Execution Time
                </h5>
                <small class="text-muted">Showing top {{ top_queries|length }} queries sorted by cumulative execution time</small>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Namespace</th>
                                <th>Operation</th>
                                <th class="text-end">Execution Count</th>
                                <th class="text-end">Mean Duration</th>
                                <th class="text-end">Max Duration</th>
                                <th class="text-end">Total Time</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for query in top_queries %}
                            <tr>
                                <td>
                                    <code class="text-primary">{{ query.namespace }}</code>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if query.operation == 'find' %}bg-primary
                                        {% elif query.operation == 'aggregate' %}bg-success
                                        {% elif query.operation == 'update' %}bg-warning
                                        {% elif query.operation == 'insert' %}bg-info
                                        {% elif query.operation == 'delete' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ query.operation.upper() }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <strong>{{ "{:,}".format(query.execution_count) }}</strong>
                                </td>
                                <td class="text-end">
                                    <div class="{% if query.mean_duration > 5000 %}text-danger fw-bold{% elif query.mean_duration > 1000 %}text-warning fw-bold{% else %}text-muted{% endif %}">
                                        {{ query.mean_duration_formatted }}
                                        <br><small class="text-muted" style="font-size: 0.65rem;">{{ query.mean_duration_raw }}</small>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <div class="{% if query.max_duration > 10000 %}text-danger fw-bold{% elif query.max_duration > 5000 %}text-warning fw-bold{% else %}text-muted{% endif %}">
                                        {{ query.max_duration_formatted }}
                                        <br><small class="text-muted" style="font-size: 0.65rem;">{{ query.max_duration_raw }}</small>
                                    </div>
                                </td>
                                <td class="text-end">
                                    <strong class="{% if query.sum_duration > 300000 %}text-danger{% elif query.sum_duration > 60000 %}text-warning{% else %}text-muted{% endif %}">
                                        {{ query.sum_duration_formatted }}
                                    </strong>
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="showQueryDetails('{{ query.pattern_key }}')"
                                            title="View query details">
                                        <i class="fas fa-info-circle"></i> Details
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="row">
    <div class="col-12">
        <div class="card card-stats text-center py-5">
            <div class="card-body">
                <div class="stats-icon bg-secondary text-white mx-auto mb-4">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h4 class="mt-3">No Query Data Available</h4>
                <p class="text-muted">
                    No query execution data found for profiling analysis. 
                    Make sure you have uploaded log files with slow query data.
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Query Details Modal -->
<div class="modal fade" id="queryDetailsModal" tabindex="-1" aria-labelledby="queryDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="queryDetailsModalLabel">
                    <i class="fas fa-code"></i> Query Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="queryDetailsContent" style="max-height: 500px; overflow-y: auto;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="showFullQueryBtn">
                    <i class="fas fa-eye"></i> Show Full Query
                </button>
            </div>
        </div>
    </div>
</div>

{% if trend_data %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // Prepare data for Plotly
    const trendData = {{ trend_data | tojson | safe }};
    const queryDetails = {{ query_details | tojson | safe }};
    
    // Group data by operation type for different colors
    const operations = [...new Set(trendData.map(d => d.operation))];
    const colors = {
        'find': '#0d6efd',
        'aggregate': '#198754', 
        'update': '#ffc107',
        'insert': '#0dcaf0',
        'delete': '#dc3545',
        'other': '#6c757d',
        'unknown': '#6f42c1'
    };
    
    const traces = operations.map((operation) => {
        const opData = trendData.filter(d => d.operation === operation);
        
        return {
            x: opData.map(d => d.timestamp),
            y: opData.map(d => d.duration),
            mode: 'markers',
            type: 'scatter',
            name: operation.toUpperCase(),
            marker: {
                color: colors[operation] || colors['unknown'],
                size: 8,
                opacity: 0.7,
                line: {
                    width: 1,
                    color: 'white'
                }
            },
            text: opData.map(d => 
                `<b>${d.namespace}</b><br>` +
                `Operation: ${d.operation}<br>` +
                `Duration: ${d.duration.toLocaleString()}ms<br>` +
                `Avg for Pattern: ${d.avg_duration.toFixed(0)}ms<br>` +
                `Query Hash: ${d.query_hash}<br>` +
                `Time: ${new Date(d.timestamp).toLocaleString()}<br>` +
                `<i>Click for details</i>`
            ),
            hovertemplate: '%{text}<extra></extra>',
            customdata: opData.map(d => ({
                query_hash: d.query_hash,
                namespace: d.namespace,
                operation: d.operation,
                duration: d.duration,
                timestamp: d.timestamp,
                avg_duration: d.avg_duration,
                group_key: d.pattern_key
            }))
        };
    });
    
    const layout = {
        title: {
            text: 'Query Execution Time Over Time',
            font: { size: 16 }
        },
        xaxis: {
            title: 'Time',
            type: 'date',
            gridcolor: '#f8f9fa',
            linecolor: '#dee2e6'
        },
        yaxis: {
            title: 'Duration (milliseconds)',
            type: 'log',
            tickformat: ',d',
            gridcolor: '#f8f9fa',
            linecolor: '#dee2e6'
        },
        hovermode: 'closest',
        showlegend: true,
        legend: {
            orientation: 'h',
            y: -0.2,
            x: 0.5,
            xanchor: 'center'
        },
        margin: { l: 80, r: 50, t: 60, b: 100 },
        plot_bgcolor: 'white',
        paper_bgcolor: 'white'
    };
    
    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
        displaylogo: false
    };
    
    Plotly.newPlot('trendChart', traces, layout, config);
    
    // Add click handler for query details
    document.getElementById('trendChart').on('plotly_click', function(data) {
        const point = data.points[0];
        const customData = point.customdata;
        
        if (customData && customData.query_hash) {
            showQueryDetailsFromChart(customData);
        }
    });
    
    // Function to show query details from chart click
    function showQueryDetailsFromChart(pointData) {
        const lookupKey = pointData.group_key || pointData.query_hash;
        const details = queryDetails[lookupKey];
        if (!details) {
            alert('Query details not available');
            return;
        }

        const modalContent = document.getElementById('queryDetailsContent');
        modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-database"></i> Query Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Namespace:</strong></td><td>${details.namespace}</td></tr>
                        <tr><td><strong>Operation:</strong></td><td><span class="badge bg-primary">${details.operation_type}</span></td></tr>
                        <tr><td><strong>Primary Query Hash:</strong></td><td><code>${details.query_hash || 'MIXED'}</code></td></tr>
                        <tr><td><strong>Group Key:</strong></td><td><code>${lookupKey}</code></td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-tachometer-alt"></i> Performance Metrics</h6>
                    <table class="table table-sm">
                        <tr><td><strong>This Execution:</strong></td><td>${pointData.duration.toLocaleString()}ms</td></tr>
                        <tr><td><strong>Average Duration:</strong></td><td>${details.avg_duration.toFixed(0)}ms</td></tr>
                        <tr><td><strong>Total Executions:</strong></td><td>${details.execution_count.toLocaleString()}</td></tr>
                    </table>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-history"></i> Recent Executions</h6>
                    <div class="table-responsive" style="max-height: 200px;">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr><th>Timestamp</th><th>Duration</th></tr>
                            </thead>
                            <tbody>
                                ${details.executions.map(ex => 
                                    `<tr><td>${new Date(ex.timestamp).toLocaleString()}</td><td>${ex.duration}ms</td></tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="fullQueryContent" style="display: none;">
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="fas fa-code"></i> Full Query</h6>
                        <pre class="bg-light p-3 border rounded" style="max-height: 300px; overflow-y: auto; font-size: 0.875rem;">${details.sample_query || 'Query text not available'}</pre>
                    </div>
                </div>
            </div>
        `;
        
        // Set up show full query button
        document.getElementById('showFullQueryBtn').onclick = function() {
            const fullQueryDiv = document.getElementById('fullQueryContent');
            if (fullQueryDiv.style.display === 'none') {
                fullQueryDiv.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Full Query';
            } else {
                fullQueryDiv.style.display = 'none';
                this.innerHTML = '<i class="fas fa-eye"></i> Show Full Query';
            }
        };
        
        // Show modal
        new bootstrap.Modal(document.getElementById('queryDetailsModal')).show();
    }
    
    // Function to show query details from table button
    function showQueryDetails(queryHash) {
        const details = queryDetails[queryHash];
        if (!details) {
            alert('Query details not available');
            return;
        }

        const modalContent = document.getElementById('queryDetailsContent');
        modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-database"></i> Query Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Namespace:</strong></td><td>${details.namespace}</td></tr>
                        <tr><td><strong>Operation:</strong></td><td><span class="badge bg-primary">${details.operation_type}</span></td></tr>
                        <tr><td><strong>Primary Query Hash:</strong></td><td><code>${details.query_hash || 'MIXED'}</code></td></tr>
                        <tr><td><strong>Group Key:</strong></td><td><code>${details.pattern_key}</code></td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-tachometer-alt"></i> Performance Metrics</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Average Duration:</strong></td><td>${details.avg_duration.toFixed(0)}ms</td></tr>
                        <tr><td><strong>Total Executions:</strong></td><td>${details.execution_count.toLocaleString()}</td></tr>
                    </table>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6><i class="fas fa-history"></i> Recent Executions</h6>
                    <div class="table-responsive" style="max-height: 200px;">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr><th>Timestamp</th><th>Duration</th></tr>
                            </thead>
                            <tbody>
                                ${details.executions.map(ex => 
                                    `<tr><td>${new Date(ex.timestamp).toLocaleString()}</td><td>${ex.duration}ms</td></tr>`
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="fullQueryContent" style="display: none;">
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="fas fa-code"></i> Full Query</h6>
                        <pre class="bg-light p-3 border rounded" style="max-height: 300px; overflow-y: auto; font-size: 0.875rem;">${details.sample_query || 'Query text not available'}</pre>
                    </div>
                </div>
            </div>
        `;
        
        // Set up show full query button
        document.getElementById('showFullQueryBtn').onclick = function() {
            const fullQueryDiv = document.getElementById('fullQueryContent');
            if (fullQueryDiv.style.display === 'none') {
                fullQueryDiv.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Full Query';
            } else {
                fullQueryDiv.style.display = 'none';
                this.innerHTML = '<i class="fas fa-eye"></i> Show Full Query';
            }
        };
        
        // Show modal
        new bootstrap.Modal(document.getElementById('queryDetailsModal')).show();
    }
    
    // Handle grouping option changes
    document.addEventListener('DOMContentLoaded', function() {
        const groupingOptions = document.querySelectorAll('input[name="groupingType"]');
        
        groupingOptions.forEach(option => {
            option.addEventListener('change', function() {
                if (this.checked) {
                    // Get current URL and update groupingType parameter
                    const url = new URL(window.location);
                    url.searchParams.set('groupingType', this.value);
                    
                    // Reload page with new grouping
                    window.location.href = url.toString();
                }
            });
        });
    });
</script>
{% endif %}
{% endblock %}
