{% extends "base.html" %}

{% block title %}Slow Query Analysis - MongoDB Log Analyzer{% endblock %}

{% block content %}
<style>
.action-btn {
    width: 36px !important;
    height: 32px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border-radius: 6px !important;
    padding: 0 !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
}

.action-btn:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15) !important;
}

.table td.actions-column {
    vertical-align: middle !important;
    text-align: center !important;
    width: 80px !important;
    padding: 8px 4px !important;
}

.table th.actions-header {
    text-align: center !important;
    width: 80px !important;
}

.table th {
    text-align: center !important;
    vertical-align: middle !important;
}

.table td {
    text-align: center !important;
    vertical-align: middle !important;
}

.table td:nth-child(2),
.table td:nth-child(3) {
    text-align: left !important;
}
</style>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Slow Query Analysis</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-success" id="exportBtn">
                <i class="fas fa-download me-2"></i>Export Analysis
            </button>
            <a href="{{ url_for('slow_queries') }}" class="btn btn-sm btn-info">
                <i class="fas fa-list me-2"></i>List of Slow Queries
            </a>
            <a href="{{ url_for('index_suggestions') }}" class="btn btn-sm btn-warning">
                <i class="fas fa-lightbulb me-2"></i>Index Suggestions
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-filter me-2"></i>Filter Options</h5>
                {% if min_date and max_date %}
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>Log data available from {{ min_date }} to {{ max_date }}
                </small>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('slow_query_analysis') }}" class="row g-3" id="analysis-filter-form">
                    <input type="hidden" name="exclude_system_db_flag" value="1">
                    <div class="col-12">
                        <div class="d-flex flex-wrap align-items-center">
                            <span class="me-2 fw-bold text-info"><i class="fas fa-object-group me-1"></i>Group By:</span>
                            <div class="btn-group" role="group" aria-label="Grouping selection">
                                {% set group_options = [
                                    {'label': 'Pattern', 'value': 'pattern_key'},
                                    {'label': 'Namespace', 'value': 'namespace'},
                                    {'label': 'Query Hash', 'value': 'query_hash'}
                                ] %}
                                {% for option in group_options %}
                                <input type="radio" class="btn-check" name="grouping" id="grouping_{{ option.value }}" value="{{ option.value }}" {% if grouping_type == option.value %}checked{% endif %}>
                                <label class="btn btn-outline-secondary btn-sm" for="grouping_{{ option.value }}">{{ option.label }}</label>
                                {% endfor %}
                            </div>
                            <small class="text-muted ms-3">
                                {% if grouping_type == 'pattern_key' %}
                                    Groups by query structure + namespace + plan summary.
                                {% elif grouping_type == 'namespace' %}
                                    Groups by database.collection only.
                                {% else %}
                                    Groups by query hash (structure).
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="datetime-local" class="form-control" id="start_date" name="start_date" 
                               value="{{ start_date or '' }}"
                               {% if min_date %}min="{{ min_date }}"{% endif %}
                               {% if max_date %}max="{{ max_date }}"{% endif %}>
                        {% if min_date %}
                        <small class="form-text text-muted">Available: {{ min_date }} to {{ max_date }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="datetime-local" class="form-control" id="end_date" name="end_date" 
                               value="{{ end_date or '' }}"
                               {% if min_date %}min="{{ min_date }}"{% endif %}
                               {% if max_date %}max="{{ max_date }}"{% endif %}>
                        {% if max_date %}
                        <small class="form-text text-muted">Available: {{ min_date }} to {{ max_date }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-12 mt-2">
                        <input type="hidden" name="exclude_system_db_flag" value="1">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="1" id="exclude_system_db" name="exclude_system_db" {% if exclude_system_db %}checked{% endif %}>
                            <label class="form-check-label" for="exclude_system_db">
                                Exclude MongoDB system databases
                            </label>
                        </div>
                        {% if min_date and max_date %}
                        <div class="mb-2">
                            <small class="text-muted me-2">Quick Select:</small>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('all')">
                                <i class="fas fa-calendar-alt me-1"></i>All Data
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('today')">
                                <i class="fas fa-calendar-day me-1"></i>Today
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('last24h')">
                                <i class="fas fa-clock me-1"></i>Last 24h
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('last7d')">
                                <i class="fas fa-calendar-week me-1"></i>Last 7 days
                            </button>
                        </div>
                        {% endif %}
                        <div class="d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter me-2"></i>Apply Filters
                            </button>
                            <a href="{{ url_for('slow_query_analysis') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-2"></i>Reset
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-stats border-left-primary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Unique {{ grouping_label }}</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ patterns|length }}</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-primary text-white">
                            <i class="fas fa-fingerprint"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stats border-left-warning">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Executions</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_executions }}</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-warning text-white">
                            <i class="fas fa-play-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stats border-left-info">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Avg Duration</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ avg_duration|round|int }}ms</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-info text-white">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stats border-left-danger">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">High Priority Issues</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ high_priority_count }}</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-danger text-white">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not patterns %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-chart-line fa-3x text-muted"></i>
                </div>
                <h4 class="text-muted">No Query Patterns Found</h4>
                <p class="text-muted">
                    No slow queries available for analysis. Upload log files or check if slow queries exist.
                </p>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>Upload Logs
                </a>
            </div>
        </div>
    </div>
</div>
{% else %}

<!-- Query Pattern Analysis Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>{{ grouping_label }} Performance Analysis
                    </h5>
                    <small class="text-muted">(Sorted by total impact: avg duration Ã— execution count)</small>
                </div>
                <span class="badge bg-light text-muted mt-2 mt-md-0">Group By: {{ grouping_label }}</span>
            </div>
            <div class="card-body">
                <!-- Pagination controls -->
                {% if pagination %}
                    {% include 'pagination.html' %}
                {% endif %}
                
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-primary">
                            <tr>
                                <th style="color: #000; font-weight: bold;">Priority</th>
                                <th style="color: #000; font-weight: bold;">Collection</th>
                                <th style="color: #000; font-weight: bold;">Hash</th>
                                <th style="color: #000; font-weight: bold;">Operation</th>
                                <th style="color: #000; font-weight: bold;">Plan</th>
                                <th style="color: #000; font-weight: bold;">Executions</th>
                                <th style="color: #000; font-weight: bold;">Avg Duration</th>
                                <th style="color: #000; font-weight: bold;">Min/Max</th>
                                <th style="color: #000; font-weight: bold;">Selectivity</th>
                                <th class="actions-header" style="color: #000; font-weight: bold;">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pattern_key, pattern in patterns.items() %}
                            <tr>
                                <td>
                                    {% if pattern.optimization_potential == 'high' %}
                                        <span class="badge bg-danger">High</span>
                                    {% elif pattern.optimization_potential == 'medium' %}
                                        <span class="badge bg-warning">Medium</span>
                                    {% else %}
                                        <span class="badge bg-success">Low</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ pattern.database }}.{{ pattern.collection }}</strong>
                                    </div>
                                </td>
                                <td>
                                    {% set hash_value = pattern.query_hash or '' %}
                                    <code class="text-primary" title="{{ hash_value }}">
                                        {% if hash_value|length > 10 %}
                                            {{ hash_value[:10] }}...
                                        {% else %}
                                            {{ hash_value }}
                                        {% endif %}
                                    </code>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ pattern.query_type }}</span>
                                </td>
                                <td>
                                    {% set index_info = pattern.plan_summary|extract_index_info %}
                                    {% if index_info.scan_type == 'COLLSCAN' %}
                                        <span class="badge bg-danger" title="Full collection scan - high optimization priority">
                                            <i class="fas fa-exclamation-triangle me-1"></i>COLLSCAN
                                        </span>
                                    {% elif index_info.scan_type == 'IXSCAN' %}
                                        <span class="badge bg-success" title="{{ index_info.display_text }}">
                                            <i class="fas fa-search me-1"></i>IXSCAN
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary" title="{{ index_info.display_text }}">{{ pattern.plan_summary }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ pattern.total_count }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        {{ ((pattern.last_seen - pattern.first_seen).total_seconds() / 3600)|round(1) if pattern.first_seen and pattern.last_seen else 0 }}h span
                                    </small>
                                </td>
                                <td class="text-center">
                                    <strong>{{ pattern.avg_duration|round|int }}ms</strong>
                                </td>
                                <td class="text-center">
                                    <div class="text-success">{{ pattern.min_duration|round|int }}ms</div>
                                    <div class="text-danger">{{ pattern.max_duration|round|int }}ms</div>
                                </td>
                                <td class="text-center">
                                    {% if pattern.total_docs_examined > 0 %}
                                        {% if pattern.avg_selectivity == 0 %}
                                            <div class="text-warning">0.0%</div>
                                            <small class="text-muted">
                                                {{ pattern.total_returned }}/{{ pattern.total_docs_examined }}
                                                <br><span class="badge bg-warning">No Results</span>
                                            </small>
                                        {% else %}
                                            <div>{{ pattern.avg_selectivity|round(4) }}%</div>
                                            <small class="text-muted">
                                                {{ pattern.total_returned }}/{{ pattern.total_docs_examined }}
                                                {% if pattern.get('is_estimated') %}
                                                    <br><span class="badge bg-info">est.</span>
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                        <br><small class="text-muted">No data examined</small>
                                    {% endif %}
                                </td>
                                <td class="actions-column">
                                    <button
                                        class="btn btn-sm btn-outline-primary view-details-btn action-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#patternModal"
                                        data-pattern-key="{{ pattern_key }}"
                                        data-collection="{{ pattern.database }}.{{ pattern.collection }}"
                                        data-query-type="{{ pattern.query_type }}"
                                        data-plan-summary="{{ pattern.plan_summary }}"
                                        data-query-hash="{{ pattern.query_hash }}"
                                        data-synthetic-hash="{{ 'true' if pattern.is_synthetic_hash else 'false' }}"
                                        data-executions="{{ pattern.total_count }}"
                                        data-avg-duration="{{ pattern.avg_duration|round|int }}"
                                        data-min-duration="{{ pattern.min_duration|round|int }}"
                                        data-max-duration="{{ pattern.max_duration|round|int }}"
                                        data-selectivity="{{ pattern.avg_selectivity|round(1) }}"
                                        data-total-returned="{{ pattern.total_returned }}"
                                        data-total-docs-examined="{{ pattern.total_docs_examined }}"
                                        data-index-efficiency="{{ pattern.avg_index_efficiency|round(1) }}"
                                        data-optimization-potential="{{ pattern.optimization_potential }}"
                                        data-slowest-query="{{ pattern.slowest_query_full|e }}"
                                        title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pattern Details Modal -->
<div class="modal fade" id="patternModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Query Pattern Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>Pattern Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Collection:</strong></td><td id="modalCollection"></td></tr>
                            <tr><td><strong>Query Type:</strong></td><td id="modalQueryType"></td></tr>
                            <tr><td><strong>Plan Summary:</strong></td><td id="modalPlanSummary"></td></tr>
                            <tr><td><strong>Query Hash:</strong></td><td id="modalQueryHash"></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-clock me-2"></i>Performance Statistics</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Total Executions:</strong></td><td id="modalExecutions"></td></tr>
                            <tr><td><strong>Avg Duration:</strong></td><td id="modalAvgDuration"></td></tr>
                            <tr><td><strong>Min/Max Duration:</strong></td><td id="modalMinMaxDuration"></td></tr>
                            <tr id="modalDocsRow" style="display: none;"><td><strong>Docs Examined:</strong></td><td id="modalDocs"></td></tr>
                            <tr id="modalReturnedRow" style="display: none;"><td><strong>Docs Returned:</strong></td><td id="modalReturned"></td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <h6><i class="fas fa-chart-pie me-2"></i>Efficiency Metrics</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="h4 mb-0" id="modalSelectivity">-</div>
                                        <small class="text-muted">Selectivity</small>
                                        <div><small id="modalSelectivityDetail">-</small></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="h4 mb-0" id="modalIndexEfficiency">-</div>
                                        <small class="text-muted">Index Efficiency</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="h4 mb-0" id="modalOptimizationPotential">-</div>
                                        <small class="text-muted">Optimization Potential</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-code me-2"></i>Slowest Query</h6>
                    <pre id="modalSampleQuery" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-size: 12px;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyPatternQuery(event)">
                    <i class="fas fa-copy me-2"></i>Copy Query
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Global variable for copy functionality
let currentPatternQuery = '';

    document.addEventListener('DOMContentLoaded', function() {
        // Modal functionality
        const patternModal = document.getElementById('patternModal');
        const viewDetailsButtons = document.querySelectorAll('.view-details-btn');
    
    viewDetailsButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Get data from individual attributes
            const collection = this.getAttribute('data-collection');
            const queryType = this.getAttribute('data-query-type');
            const planSummary = this.getAttribute('data-plan-summary');
            const queryHash = this.getAttribute('data-query-hash');
            const executions = this.getAttribute('data-executions');
            const avgDuration = this.getAttribute('data-avg-duration');
            const minDuration = this.getAttribute('data-min-duration');
            const maxDuration = this.getAttribute('data-max-duration');
            const selectivity = parseFloat(this.getAttribute('data-selectivity'));
            const totalReturned = this.getAttribute('data-total-returned');
            const totalDocsExamined = this.getAttribute('data-total-docs-examined');
            const indexEfficiency = parseFloat(this.getAttribute('data-index-efficiency'));
            const optimizationPotential = this.getAttribute('data-optimization-potential');
            const slowestQuery = this.getAttribute('data-slowest-query');
            const isSynthetic = this.getAttribute('data-synthetic-hash') === 'true';
            
            // Populate modal with pattern data
            document.getElementById('modalCollection').textContent = collection;
            document.getElementById('modalQueryType').innerHTML = `<span class="badge bg-info">${queryType}</span>`;
            
            const planBadgeClass = planSummary === 'COLLSCAN' ? 'bg-danger' : 
                                  planSummary === 'IXSCAN' ? 'bg-success' : 'bg-secondary';
            document.getElementById('modalPlanSummary').innerHTML = `<span class="badge ${planBadgeClass}">${planSummary}</span>`;
            
            const hashCell = document.getElementById('modalQueryHash');
            if (isSynthetic) {
                hashCell.innerHTML = `${queryHash} <span class="badge bg-secondary ms-2">Synthetic</span>`;
            } else {
                hashCell.textContent = queryHash;
            }
            
            // Performance statistics
            document.getElementById('modalExecutions').textContent = executions;
            document.getElementById('modalAvgDuration').textContent = `${avgDuration}ms`;
            document.getElementById('modalMinMaxDuration').textContent = `${minDuration}ms / ${maxDuration}ms`;
            const docs = parseInt(totalDocsExamined, 10) || 0;
            const returned = parseInt(totalReturned, 10) || 0;
            if (docs > 0) {
                document.getElementById('modalDocs').textContent = docs.toLocaleString();
                document.getElementById('modalDocsRow').style.display = '';
            } else {
                document.getElementById('modalDocsRow').style.display = 'none';
            }
            if (returned > 0 || docs > 0) {
                document.getElementById('modalReturned').textContent = returned.toLocaleString();
                document.getElementById('modalReturnedRow').style.display = '';
            } else {
                document.getElementById('modalReturnedRow').style.display = 'none';
            }
            
            // Efficiency metrics
            if (selectivity !== null && selectivity > 0 && totalDocsExamined > 0) {
                document.getElementById('modalSelectivity').textContent = `${selectivity.toFixed(4)}%`;
                document.getElementById('modalSelectivityDetail').textContent = `${totalReturned}/${totalDocsExamined} docs`;
            } else {
                document.getElementById('modalSelectivity').textContent = 'N/A';
                document.getElementById('modalSelectivityDetail').textContent = `${totalReturned}/${totalDocsExamined} docs`;
            }
            
            document.getElementById('modalIndexEfficiency').textContent = indexEfficiency > 0 ? 
                `${indexEfficiency}%` : 'N/A';
            
            const potentialBadgeClass = optimizationPotential === 'high' ? 'bg-danger' : 
                                       optimizationPotential === 'medium' ? 'bg-warning' : 'bg-success';
            document.getElementById('modalOptimizationPotential').innerHTML = `<span class="badge ${potentialBadgeClass}">${optimizationPotential}</span>`;
            
            // Slowest query
            document.getElementById('modalSampleQuery').textContent = slowestQuery;
            currentPatternQuery = slowestQuery;
        });
    });
    
    // Export functionality
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const params = new URLSearchParams(window.location.search);
            const exportUrl = '{{ url_for("export_query_analysis") }}' + (params.toString() ? `?${params.toString()}` : '');
            window.open(exportUrl, '_blank');
        });
    }

    // Auto-submit on grouping change
    const groupingRadios = document.querySelectorAll('input[name="grouping"]');
    groupingRadios.forEach((radio) => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const form = document.getElementById('analysis-filter-form');
                if (form) {
                    form.submit();
                }
            }
        });
    });

    const excludeCheckbox = document.getElementById('exclude_system_db');
    if (excludeCheckbox) {
        excludeCheckbox.addEventListener('change', function() {
            const form = document.getElementById('analysis-filter-form');
            if (form) {
                form.submit();
            }
        });
    }
});

// Copy query function
function copyPatternQuery(event) {
    console.log('Copy button clicked, currentPatternQuery:', currentPatternQuery ? 'Query loaded' : 'Empty');
    
    if (!currentPatternQuery) {
        alert('No query to copy. Please click "View Details" first.');
        return;
    }
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentPatternQuery).then(function() {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        }).catch(function(err) {
            console.error('Copy failed:', err);
            alert('Copy failed. Please select and copy manually.');
        });
    } else {
        alert('Copy functionality not supported in this browser.');
    }
}

// Date range functionality
function setDateRange(range) {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const now = new Date();
    
    // Get the available date range from the template
    const minDateStr = "{{ min_date if min_date else '' }}";
    const maxDateStr = "{{ max_date if max_date else '' }}";
    
    let startDate, endDate;
    
    switch(range) {
        case 'all':
            startDate = minDateStr ? new Date(minDateStr.replace(' ', 'T')) : null;
            endDate = maxDateStr ? new Date(maxDateStr.replace(' ', 'T')) : null;
            break;
        case 'today':
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            startDate = today;
            endDate = new Date(today.getTime() + 24*60*60*1000 - 1); // End of day
            break;
        case 'last24h':
            endDate = new Date(now);
            startDate = new Date(now.getTime() - 24*60*60*1000);
            break;
        case 'last7d':
            endDate = new Date(now);
            startDate = new Date(now.getTime() - 7*24*60*60*1000);
            break;
    }
    
    // Apply min/max constraints
    if (minDateStr && startDate) {
        const minDate = new Date(minDateStr.replace(' ', 'T'));
        if (startDate < minDate) startDate = minDate;
    }
    if (maxDateStr && endDate) {
        const maxDate = new Date(maxDateStr.replace(' ', 'T'));
        if (endDate > maxDate) endDate = maxDate;
    }
    
    // Set the input values
    if (startDate) {
        startDateInput.value = formatDateTimeLocal(startDate);
    } else {
        startDateInput.value = '';
    }
    
    if (endDate) {
        endDateInput.value = formatDateTimeLocal(endDate);
    } else {
        endDateInput.value = '';
    }
}

function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}
</script>

{% endblock %}
