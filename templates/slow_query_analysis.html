{% extends "base.html" %}

{% block title %}Slow Query Analysis - MongoDB Log Analyzer{% endblock %}

{% block content %}
<style>
.table td,
.table th {
    vertical-align: middle !important;
}

.table td.numeric,
.table th.numeric {
    text-align: right !important;
    white-space: nowrap !important;
}

.table td.actions,
.table th.actions {
    text-align: center !important;
    width: 90px !important;
}

.badge-plan {
    font-size: 0.75rem !important;
    padding: 0.4rem 0.6rem !important;
    letter-spacing: 0.02em !important;
}

.badge-index {
    font-size: 0.7rem !important;
    padding: 0.3rem 0.5rem !important;
}

.impact-score {
    font-weight: 600 !important;
    color: #495057 !important;
}
</style>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Slow Query Analysis</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-success" id="exportBtn">
                <i class="fas fa-download me-2"></i>Export Analysis
            </button>
            <a href="{{ url_for('slow_queries') }}" class="btn btn-sm btn-info">
                <i class="fas fa-list me-2"></i>List of Slow Queries
            </a>
            <a href="{{ url_for('index_suggestions') }}" class="btn btn-sm btn-warning">
                <i class="fas fa-lightbulb me-2"></i>Index Suggestions
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-filter me-2"></i>Filter Options</h5>
                {% if min_date and max_date %}
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>Log data available from {{ min_date }} to {{ max_date }}
                </small>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('slow_query_analysis') }}" class="row g-3">
                    <div class="col-md-6">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="datetime-local" class="form-control" id="start_date" name="start_date" 
                               value="{{ start_date or '' }}"
                               {% if min_date %}min="{{ min_date }}"{% endif %}
                               {% if max_date %}max="{{ max_date }}"{% endif %}>
                        {% if min_date %}
                        <small class="form-text text-muted">Available: {{ min_date }} to {{ max_date }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="datetime-local" class="form-control" id="end_date" name="end_date" 
                               value="{{ end_date or '' }}"
                               {% if min_date %}min="{{ min_date }}"{% endif %}
                               {% if max_date %}max="{{ max_date }}"{% endif %}>
                        {% if max_date %}
                        <small class="form-text text-muted">Available: {{ min_date }} to {{ max_date }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-12 mt-2">
                        {% if min_date and max_date %}
                        <div class="mb-2">
                            <small class="text-muted me-2">Quick Select:</small>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('all')">
                                <i class="fas fa-calendar-alt me-1"></i>All Data
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('today')">
                                <i class="fas fa-calendar-day me-1"></i>Today
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('last24h')">
                                <i class="fas fa-clock me-1"></i>Last 24h
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info me-1" onclick="setDateRange('last7d')">
                                <i class="fas fa-calendar-week me-1"></i>Last 7 days
                            </button>
                        </div>
                        {% endif %}
                        <div class="col-md-12 mt-3">
                            <label class="form-label fw-bold"><i class="fas fa-object-group me-1"></i>Group Results By</label>
                            <div class="btn-group" role="group" aria-label="Grouping options">
                                <input type="radio" class="btn-check" name="grouping" id="group_pattern" value="pattern_key"
                                       {% if grouping_type == 'pattern_key' %}checked{% endif %}>
                                <label class="btn btn-outline-info btn-sm" for="group_pattern">
                                    <i class="fas fa-fingerprint me-1"></i>Pattern
                                </label>

                                <input type="radio" class="btn-check" name="grouping" id="group_namespace" value="namespace"
                                       {% if grouping_type == 'namespace' %}checked{% endif %}>
                                <label class="btn btn-outline-info btn-sm" for="group_namespace">
                                    <i class="fas fa-database me-1"></i>Namespace
                                </label>

                                <input type="radio" class="btn-check" name="grouping" id="group_hash" value="query_hash"
                                       {% if grouping_type == 'query_hash' %}checked{% endif %}>
                                <label class="btn btn-outline-info btn-sm" for="group_hash">
                                    <i class="fas fa-hashtag me-1"></i>Query Hash
                                </label>
                            </div>
                            <small class="text-muted d-block mt-1">
                                Pattern = query hash + namespace + plan. Namespace groups by collection. Query hash groups identical query structures across collections.
                            </small>
                        </div>
                        <div class="col-md-12 mt-3">
                            <div class="form-check">
                                <!-- Hidden field to ensure a value is always sent -->
                                <input type="hidden" name="exclude_system_db" value="0">
                                <input class="form-check-input" type="checkbox" id="exclude_system_db" name="exclude_system_db" value="1"
                                       {% if exclude_system_db is not defined or exclude_system_db %}checked{% endif %}>
                                <label class="form-check-label" for="exclude_system_db">
                                    <i class="fas fa-database me-1"></i>
                                    Exclude system databases (admin, config, local, etc.)
                                </label>
                                <small class="form-text text-muted d-block">
                                    System databases: admin, config, local, system, $external, and databases starting with '$'
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-end mt-3">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter me-2"></i>Apply Filters
                            </button>
                            <a href="{{ url_for('slow_query_analysis') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-2"></i>Reset
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-stats border-left-primary">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Unique Query Patterns</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pattern_count }}</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-primary text-white">
                            <i class="fas fa-fingerprint"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stats border-left-warning">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Total Executions</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_executions }}</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-warning text-white">
                            <i class="fas fa-play-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stats border-left-info">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Avg Duration</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ avg_duration|round|int }}ms</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-info text-white">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stats border-left-danger">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">High Priority Issues</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ high_priority_count }}</div>
                    </div>
                    <div class="col-auto">
                        <div class="stats-icon bg-danger text-white">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not patterns %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-chart-line fa-3x text-muted"></i>
                </div>
                <h4 class="text-muted">No Query Patterns Found</h4>
                <p class="text-muted">
                    No slow queries available for analysis. Upload log files or check if slow queries exist.
                </p>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>Upload Logs
                </a>
            </div>
        </div>
    </div>
</div>
{% else %}

<!-- Query Pattern Analysis Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Query Pattern Performance Analysis
                    <small class="text-muted ms-2">Grouping:
                        {% if grouping_type == 'pattern_key' %}
                            Per query pattern (hash + namespace + plan)
                        {% elif grouping_type == 'namespace' %}
                            Per namespace (database.collection)
                        {% else %}
                            Per query hash (structure across namespaces)
                        {% endif %}
                    </small>
                </h5>
            </div>
            <div class="card-body">
                <!-- Pagination controls -->
                {% if pagination %}
                    {% include 'pagination.html' %}
                {% endif %}
                
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-primary">
                            <tr>
                                <th>Priority</th>
                                <th>Group Key</th>
                                <th>Plan & Index</th>
                                <th class="numeric">Executions</th>
                                <th class="numeric">Avg & Peak</th>
                                <th class="numeric">Docs / Selectivity</th>
                                <th class="numeric">Age Span</th>
                                <th class="actions">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pattern_key, pattern in patterns.items() %}
                            <tr>
                                <td>
                                    {% if pattern.optimization_potential == 'high' %}
                                        <span class="badge bg-danger">High</span>
                                    {% elif pattern.optimization_potential == 'medium' %}
                                        <span class="badge bg-warning">Medium</span>
                                    {% else %}
                                        <span class="badge bg-success">Low</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="fw-bold">{{ pattern.database }}.{{ pattern.collection }}</div>
                                    <small class="text-muted">
                                        {% if grouping_type == 'pattern_key' %}
                                            Hash {{ pattern.query_hash[:12] }}...
                                        {% elif grouping_type == 'namespace' %}
                                            Hash: {{ pattern.query_hash if pattern.query_hash != 'MIXED' else 'Mixed' }}
                                        {% else %}
                                            Namespace: {{ pattern.database }}.{{ pattern.collection }}
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    {% set index_info = pattern.plan_summary|extract_index_info %}
                                    {% if index_info.scan_type == 'COLLSCAN' %}
                                        <span class="badge badge-plan bg-danger" title="Full collection scan">
                                            <i class="fas fa-exclamation-triangle me-1"></i>COLLSCAN
                                        </span>
                                    {% elif index_info.scan_type == 'IXSCAN' %}
                                        <span class="badge badge-plan bg-success" title="{{ index_info.display_text }}">
                                            <i class="fas fa-search me-1"></i>IXSCAN
                                        </span>
                                    {% else %}
                                        <span class="badge badge-plan bg-secondary" title="{{ index_info.display_text }}">{{ pattern.plan_summary }}</span>
                                    {% endif %}
                                    {% if index_info.index_name %}
                                        <div><span class="badge badge-index bg-light text-dark">{{ index_info.index_name }}</span></div>
                                    {% endif %}
                                    <div><span class="badge bg-info text-uppercase">{{ pattern.query_type if pattern.query_type != 'mixed' else 'MIXED' }}</span></div>
                                </td>
                                <td class="numeric">
                                    <strong>{{ pattern.total_count|int }}</strong>
                                </td>
                                <td class="numeric">
                                    <div class="impact-score">{{ pattern.avg_duration|round|int }} ms</div>
                                    <small class="text-muted">Max {{ pattern.max_duration|round|int }} ms</small>
                                </td>
                                <td class="numeric">
                                    {% if pattern.total_docs_examined > 0 %}
                                        <div>{{ (pattern.avg_docs_examined|default(0))|round(0)|int }} docs avg</div>
                                        <small class="text-muted">
                                            {{ (pattern.avg_selectivity|default(0))|round(2) }}% sel.
                                            {% if pattern.get('is_estimated') %}<span class="badge bg-info ms-1">est</span>{% endif %}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">No docs</span>
                                    {% endif %}
                                </td>
                                <td class="numeric">
                                    {% if pattern.first_seen and pattern.last_seen %}
                                        <div>{{ ((pattern.last_seen - pattern.first_seen).total_seconds() / 3600)|round(1) }} h</div>
                                        <small class="text-muted">{{ pattern.first_seen.strftime('%Y-%m-%d') }} → {{ pattern.last_seen.strftime('%Y-%m-%d') }}</small>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td class="actions">
                                    <button class="btn btn-sm btn-outline-primary view-details-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#patternModal"
                                            data-pattern-key="{{ pattern_key|default('', true)|e }}"
                                            data-collection="{{ ((pattern.database|default('unknown', true)) ~ '.' ~ (pattern.collection|default('unknown', true)))|e }}"
                                            data-query-type="{{ pattern.query_type|default('unknown', true)|e }}"
                                            data-plan-summary="{{ pattern.plan_summary|default('', true)|e }}"
                                            data-query-hash="{{ pattern.query_hash|default('', true)|e }}"
                                            data-executions="{{ pattern.total_count }}"
                                            data-avg-duration="{{ pattern.avg_duration|round|int }}"
                                            data-min-duration="{{ pattern.min_duration|round|int }}"
                                            data-max-duration="{{ pattern.max_duration|round|int }}"
                                            data-selectivity="{{ (pattern.avg_selectivity|default(0))|round(2) }}"
                                            data-total-returned="{{ pattern.total_returned|default(0) }}"
                                            data-total-docs-examined="{{ pattern.total_docs_examined|default(0) }}"
                                            data-avg-docs="{{ (pattern.avg_docs_examined|default(0))|round(1) }}"
                                            data-index-efficiency="{{ (pattern.avg_index_efficiency|default(0))|round(1) }}"
                                            data-optimization-potential="{{ pattern.optimization_potential|default('low', true)|e }}"
                                            data-slowest-query="{{ pattern.slowest_query_full|default('', true)|e }}"
                                            data-grouping="{{ grouping_type|default('pattern_key', true)|e }}"
                                            title="View details">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pattern Details Modal -->
<div class="modal fade" id="patternModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Query Pattern Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
<div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>Pattern Overview</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Collection:</strong></td><td id="modalCollection"></td></tr>
                            <tr><td><strong>Grouping:</strong></td><td id="modalGrouping"></td></tr>
                            <tr><td><strong>Group Key:</strong></td><td id="modalGroupKey"></td></tr>
                            <tr><td><strong>Primary Hash:</strong></td><td id="modalQueryHash"></td></tr>
                            <tr><td><strong>Query Type:</strong></td><td id="modalQueryType"></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-clipboard-list me-2"></i>Plan & Performance</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Plan Summary:</strong></td><td id="modalPlanSummary"></td></tr>
                            <tr><td><strong>Total Executions:</strong></td><td id="modalExecutions"></td></tr>
                            <tr><td><strong>Avg Duration:</strong></td><td id="modalAvgDuration"></td></tr>
                            <tr><td><strong>Min/Max Duration:</strong></td><td id="modalMinMaxDuration"></td></tr>
                            <tr><td><strong>Avg Docs Examined:</strong></td><td id="modalAvgDocs"></td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <h6><i class="fas fa-chart-pie me-2"></i>Efficiency Metrics</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="text-uppercase text-muted mb-1" style="font-size: 0.7rem;">Selectivity</div>
                                        <div class="h4 mb-0" id="modalSelectivity">-</div>
                                        <div><small id="modalSelectivityDetail">-</small></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="text-uppercase text-muted mb-1" style="font-size: 0.7rem;">Index Efficiency</div>
                                        <div class="h4 mb-0" id="modalIndexEfficiency">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <div class="text-uppercase text-muted mb-1" style="font-size: 0.7rem;">Optimization Potential</div>
                                        <div class="h4 mb-0" id="modalOptimizationPotential">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6><i class="fas fa-code me-2"></i>Representative Query</h6>
                    <pre id="modalSampleQuery" class="bg-light p-3 rounded" style="max-height: 220px; overflow-y: auto; font-size: 12px;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyPatternQuery(event)">
                    <i class="fas fa-copy me-2"></i>Copy Query
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    window.currentPatternQuery = '';
    // Pattern modal handling
    const detailButtons = document.querySelectorAll('.view-details-btn');
    const modalCollection = document.getElementById('modalCollection');
    const modalGrouping = document.getElementById('modalGrouping');
    const modalGroupKey = document.getElementById('modalGroupKey');
    const modalQueryHash = document.getElementById('modalQueryHash');
    const modalQueryType = document.getElementById('modalQueryType');
    const modalPlanSummary = document.getElementById('modalPlanSummary');
    const modalExecutions = document.getElementById('modalExecutions');
    const modalAvgDuration = document.getElementById('modalAvgDuration');
    const modalMinMaxDuration = document.getElementById('modalMinMaxDuration');
    const modalAvgDocs = document.getElementById('modalAvgDocs');
    const modalSelectivity = document.getElementById('modalSelectivity');
    const modalSelectivityDetail = document.getElementById('modalSelectivityDetail');
    const modalIndexEfficiency = document.getElementById('modalIndexEfficiency');
    const modalOptimizationPotential = document.getElementById('modalOptimizationPotential');
    const modalSampleQuery = document.getElementById('modalSampleQuery');

    const groupingLabels = {
        'pattern_key': 'Pattern',
        'namespace': 'Namespace',
        'query_hash': 'Query Hash'
    };

    detailButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const dataset = btn.dataset;
            const collection = dataset.collection || 'unknown';
            const groupingType = dataset.grouping || 'pattern_key';
            const patternKey = dataset.patternKey || '';
            const queryType = dataset.queryType || 'unknown';
            const planSummary = dataset.planSummary || 'unknown';
            const queryHash = dataset.queryHash || 'unknown';
            const executions = Number(dataset.executions || 0);
            const avgDuration = Number(dataset.avgDuration || 0);
            const minDuration = Number(dataset.minDuration || 0);
            const maxDuration = Number(dataset.maxDuration || 0);
            const avgDocsExamined = Number(dataset.avgDocs || 0);
            const selectivity = parseFloat(dataset.selectivity || '0');
            const totalReturned = Number(dataset.totalReturned || 0);
            const totalDocsExamined = Number(dataset.totalDocsExamined || 0);
            const indexEfficiency = parseFloat(dataset.indexEfficiency || '0');
            const optimizationPotential = dataset.optimizationPotential || 'low';
            const slowestQuery = dataset.slowestQuery || 'Query text not available';

            modalCollection.textContent = collection;
            const groupingLabel = groupingLabels[groupingType] || groupingType;
            modalGrouping.innerHTML = `<span class="badge bg-secondary text-uppercase">${groupingLabel}</span>`;
            modalGroupKey.textContent = patternKey;
            modalQueryHash.textContent = queryHash;
            modalQueryType.innerHTML = `<span class="badge bg-info">${queryType}</span>`;

            let planClass = 'badge bg-secondary';
            if (planSummary === 'COLLSCAN') planClass = 'badge bg-danger';
            if (planSummary === 'IXSCAN') planClass = 'badge bg-success';
            modalPlanSummary.innerHTML = `<span class="${planClass}">${planSummary}</span>`;

            modalExecutions.textContent = executions.toLocaleString();
            modalAvgDuration.textContent = `${Math.round(avgDuration)} ms`;
            modalMinMaxDuration.textContent = `${Math.round(minDuration)} ms / ${Math.round(maxDuration)} ms`;
            modalAvgDocs.textContent = avgDocsExamined > 0 ? `${avgDocsExamined.toFixed(1)} docs` : 'N/A';

            if (totalDocsExamined > 0 && selectivity > 0) {
                modalSelectivity.textContent = `${selectivity.toFixed(2)}%`;
            } else {
                modalSelectivity.textContent = 'N/A';
            }
            modalSelectivityDetail.textContent = `${totalReturned.toLocaleString()}/${totalDocsExamined.toLocaleString()} docs total`;

            modalIndexEfficiency.textContent = indexEfficiency > 0 ? `${indexEfficiency.toFixed(1)}%` : 'N/A';

            const badgeClass = optimizationPotential === 'high' ? 'bg-danger' :
                               optimizationPotential === 'medium' ? 'bg-warning' : 'bg-success';
            modalOptimizationPotential.innerHTML = `<span class="badge ${badgeClass}">${optimizationPotential}</span>`;

            modalSampleQuery.textContent = slowestQuery;
            window.currentPatternQuery = slowestQuery;
        });
    });

// Export functionality
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            // Build export URL with current filter parameters
            const params = new URLSearchParams();

            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const excludeSystemDb = document.getElementById('exclude_system_db').checked;
            const groupingRadio = document.querySelector('input[name="grouping"]:checked');

            if (startDate) params.set('start_date', startDate);
            if (endDate) params.set('end_date', endDate);

            // Handle checkbox state with hidden field approach
            params.append('exclude_system_db', '0');  // Always add the base value
            if (excludeSystemDb) {
                params.append('exclude_system_db', '1');  // Add checked value if checked
            }

            if (groupingRadio) {
                params.set('grouping', groupingRadio.value);
            }

            const exportUrl = '{{ url_for("export_query_analysis") }}' + '?' + params.toString();
            window.open(exportUrl, '_blank');
        });
    }
});

// Copy query function
function copyPatternQuery(event) {
    const queryText = window.currentPatternQuery || '';
    console.log('Copy button clicked, currentPatternQuery:', queryText ? 'Query loaded' : 'Empty');
    
    if (!queryText) {
        alert('No query to copy. Please click "View Details" first.');
        return;
    }
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(queryText).then(function() {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
            }, 2000);
        }).catch(function(err) {
            console.error('Copy failed:', err);
            alert('Copy failed. Please select and copy manually.');
        });
    } else {
        alert('Copy functionality not supported in this browser.');
    }
}

// Date range functionality
function setDateRange(range) {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const now = new Date();
    
    // Get the available date range from the template
    const minDateStr = "{{ min_date if min_date else '' }}";
    const maxDateStr = "{{ max_date if max_date else '' }}";
    
    let startDate, endDate;
    
    switch(range) {
        case 'all':
            startDate = minDateStr ? new Date(minDateStr.replace(' ', 'T')) : null;
            endDate = maxDateStr ? new Date(maxDateStr.replace(' ', 'T')) : null;
            break;
        case 'today':
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            startDate = today;
            endDate = new Date(today.getTime() + 24*60*60*1000 - 1); // End of day
            break;
        case 'last24h':
            endDate = new Date(now);
            startDate = new Date(now.getTime() - 24*60*60*1000);
            break;
        case 'last7d':
            endDate = new Date(now);
            startDate = new Date(now.getTime() - 7*24*60*60*1000);
            break;
    }
    
    // Apply min/max constraints
    if (minDateStr && startDate) {
        const minDate = new Date(minDateStr.replace(' ', 'T'));
        if (startDate < minDate) startDate = minDate;
    }
    if (maxDateStr && endDate) {
        const maxDate = new Date(maxDateStr.replace(' ', 'T'));
        if (endDate > maxDate) endDate = maxDate;
    }
    
    // Set the input values
    if (startDate) {
        startDateInput.value = formatDateTimeLocal(startDate);
    } else {
        startDateInput.value = '';
    }
    
    if (endDate) {
        endDateInput.value = formatDateTimeLocal(endDate);
    } else {
        endDateInput.value = '';
    }
}

function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}
</script>

{% endblock %}
